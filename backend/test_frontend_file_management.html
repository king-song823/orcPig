<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‰ç«¯æ–‡ä»¶ç®¡ç†æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .file-list {
        margin: 20px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 100px;
      }
      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        margin: 4px 0;
        background: #f9f9f9;
        border-radius: 4px;
      }
      .file-preview {
        max-width: 100px;
        max-height: 100px;
        margin: 5px;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button.danger {
        background: #dc3545;
      }
      button.danger:hover {
        background: #c82333;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª å‰ç«¯æ–‡ä»¶ç®¡ç†åŠŸèƒ½æµ‹è¯•</h1>

      <div class="status info">
        <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>
        <ul>
          <li>ä¸Šä¼ å¤šä¸ªå›¾ç‰‡æ–‡ä»¶</li>
          <li>ç‚¹å‡»åˆ é™¤æŒ‰é’®åˆ é™¤å•ä¸ªæ–‡ä»¶</li>
          <li>ç‚¹å‡»æ¸…é™¤æ‰€æœ‰æŒ‰é’®æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶</li>
          <li>éªŒè¯æ–‡ä»¶æ•°é‡æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®</li>
          <li>éªŒè¯OCRè¯†åˆ«æ˜¯å¦ä½¿ç”¨æœ€æ–°æ–‡ä»¶åˆ—è¡¨</li>
        </ul>
      </div>

      <div>
        <input type="file" id="fileInput" multiple accept="image/*" />
        <button onclick="addFiles()">æ·»åŠ æ–‡ä»¶</button>
        <button onclick="clearAll()" class="danger">æ¸…é™¤æ‰€æœ‰</button>
      </div>

      <div class="status info">
        <strong>å½“å‰æ–‡ä»¶æ•°é‡ï¼š</strong> <span id="fileCount">0</span>
      </div>

      <div class="file-list" id="fileList">
        <p>æš‚æ— æ–‡ä»¶</p>
      </div>

      <div>
        <button onclick="testOCR()">æµ‹è¯•OCRè¯†åˆ«</button>
      </div>

      <div id="ocrResult" class="status" style="display: none">
        <h3>OCRè¯†åˆ«ç»“æœï¼š</h3>
        <pre id="ocrResultText"></pre>
      </div>
    </div>

    <script>
      let files = [];
      let previewImages = [];

      function addFiles() {
        const input = document.getElementById("fileInput");
        const newFiles = Array.from(input.files);

        if (newFiles.length === 0) return;

        // è¿‡æ»¤é‡å¤æ–‡ä»¶
        const filtered = newFiles.filter(
          (f) => !files.some((e) => e.name === f.name && e.size === f.size)
        );

        files = [...files, ...filtered];

        // åˆ›å»ºé¢„è§ˆ
        filtered.forEach((file) => {
          const url = URL.createObjectURL(file);
          previewImages.push({
            name: file.name,
            url: url,
          });
        });

        updateDisplay();
        input.value = null;
      }

      function removeFile(index) {
        // æ¸…ç†URLå¯¹è±¡
        URL.revokeObjectURL(previewImages[index].url);

        // åˆ é™¤æ–‡ä»¶
        files = files.filter((_, idx) => idx !== index);
        previewImages = previewImages.filter((_, idx) => idx !== index);

        updateDisplay();
      }

      function clearAll() {
        // æ¸…ç†æ‰€æœ‰URLå¯¹è±¡
        previewImages.forEach((img) => URL.revokeObjectURL(img.url));

        files = [];
        previewImages = [];
        updateDisplay();
      }

      function updateDisplay() {
        const fileCount = document.getElementById("fileCount");
        const fileList = document.getElementById("fileList");

        fileCount.textContent = files.length;

        if (files.length === 0) {
          fileList.innerHTML = "<p>æš‚æ— æ–‡ä»¶</p>";
        } else {
          fileList.innerHTML = files
            .map(
              (file, index) => `
                    <div class="file-item">
                        <div>
                            <img src="${
                              previewImages[index].url
                            }" class="file-preview" alt="${file.name}">
                            <span>${file.name} (${(file.size / 1024).toFixed(
                1
              )}KB)</span>
                        </div>
                        <button onclick="removeFile(${index})" class="danger">åˆ é™¤</button>
                    </div>
                `
            )
            .join("");
        }
      }

      async function testOCR() {
        if (files.length === 0) {
          alert("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");
          return;
        }

        const formData = new FormData();
        files.forEach((file) => formData.append("files", file));

        try {
          const response = await fetch("http://localhost:8011/parse-docs", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error("è§£æå¤±è´¥");
          const data = await response.json();

          document.getElementById("ocrResultText").textContent = JSON.stringify(
            data,
            null,
            2
          );
          document.getElementById("ocrResult").style.display = "block";
          document.getElementById("ocrResult").className = "status success";

          console.log("OCR ç»“æœ:", data);
          console.log(
            "è¯†åˆ«çš„æ–‡ä»¶:",
            files.map((f) => f.name)
          );
        } catch (error) {
          document.getElementById(
            "ocrResultText"
          ).textContent = `é”™è¯¯: ${error.message}`;
          document.getElementById("ocrResult").style.display = "block";
          document.getElementById("ocrResult").className = "status danger";
        }
      }

      // åˆå§‹åŒ–æ˜¾ç¤º
      updateDisplay();
    </script>
  </body>
</html>
